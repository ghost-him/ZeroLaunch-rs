name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ v1.0.0 æ ¼å¼çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Release
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc,aarch64-pc-windows-msvc

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Get version from tag
        id: get_version
        shell: pwsh
        run: |
          $tag = $env:GITHUB_REF -replace 'refs/tags/v', ''
          if ([string]::IsNullOrEmpty($tag)) {
            $tag = "0.0.0"
          }
          
          # ç”Ÿæˆ yymmdd æ ¼å¼çš„æ—¥æœŸ
          $date = Get-Date -Format "yyMMdd"
          $releaseTitle = "$date-v$tag"
          
          echo "VERSION=$tag" >> $env:GITHUB_OUTPUT
          echo "RELEASE_TITLE=$releaseTitle" >> $env:GITHUB_OUTPUT
          echo "Version: $tag"
          echo "Release Title: $releaseTitle"

      - name: Build all variants
        shell: pwsh
        run: |
          cd xtask
          # æ„å»ºæ‰€æœ‰æ¶æ„å’Œ AI å˜ä½“
          cargo run --bin xtask build-all --arch all --ai both
        
      - name: List build artifacts
        shell: pwsh
        run: |
          echo "=== Build artifacts ==="
          $files = Get-ChildItem -Path . -Include *.exe,*.msi,*.zip -File
          if ($files.Count -eq 0) {
            echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ„å»ºäº§ç‰©ï¼"
            exit 1
          }
          echo "æ‰¾åˆ° $($files.Count) ä¸ªæ„å»ºäº§ç‰©ï¼š"
          $files | ForEach-Object {
            $sizeMB = [math]::Round($_.Length / 1MB, 2)
            echo "  âœ… $($_.Name) ($sizeMB MB)"
          }

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.get_version.outputs.RELEASE_TITLE }}
          files: |
            *.exe
            *.msi
            *.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Gitee
        if: success()
        shell: pwsh
        run: |
          # é…ç½® Gitee
          git config --global user.name "ghost-him"
          git config --global user.email "${{ secrets.GITEE_EMAIL }}"
          
          # æ·»åŠ  Gitee è¿œç¨‹ä»“åº“
          git remote add gitee https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/ghost-him/ZeroLaunch-rs.git || true
          
          # æ¨é€ä»£ç å’Œæ ‡ç­¾åˆ° Gitee
          git push gitee main --tags -f || echo "Failed to push to Gitee"
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_EMAIL: ${{ secrets.GITEE_EMAIL }}

      - name: Create Gitee Release
        if: success()
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $releaseTitle = "${{ steps.get_version.outputs.RELEASE_TITLE }}"
          $tag = "v$version"
          
          # ä½¿ç”¨ Gitee API åˆ›å»º Release
          $headers = @{
            "Content-Type" = "application/json"
            "Authorization" = "token ${{ secrets.GITEE_TOKEN }}"
          }
          
          $body = @{
            tag_name = $tag
            name = $releaseTitle
            body = "Release $releaseTitle - Auto-generated from GitHub Actions"
            prerelease = $false
          } | ConvertTo-Json
          
          try {
            $response = Invoke-RestMethod -Uri "https://gitee.com/api/v5/repos/ghost-him/ZeroLaunch-rs/releases" -Method Post -Headers $headers -Body $body
            $releaseId = $response.id
            echo "Gitee Release ID: $releaseId"
            
            # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Gitee Release
            $files = Get-ChildItem -Path . -Include *.exe,*.msi,*.zip -File
            foreach ($file in $files) {
              echo "Uploading $($file.Name) to Gitee..."
              $uploadUrl = "https://gitee.com/api/v5/repos/ghost-him/ZeroLaunch-rs/releases/$releaseId/attach_files?access_token=${{ secrets.GITEE_TOKEN }}"
              
              # ä½¿ç”¨ curl ä¸Šä¼ æ–‡ä»¶ï¼ˆæ›´å¯é ï¼‰
              curl.exe -X POST $uploadUrl -F "file=@$($file.FullName)" --silent --show-error
              
              if ($LASTEXITCODE -eq 0) {
                echo "âœ… å·²ä¸Šä¼ : $($file.Name)"
              } else {
                echo "âŒ ä¸Šä¼ å¤±è´¥: $($file.Name)"
              }
            }
          } catch {
            echo "Failed to create/upload to Gitee release: $_"
          }
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}

      - name: Upload to GitCode
        if: success()
        shell: pwsh
        run: |
          # é…ç½® GitCode
          git config --global user.name "ghost-him"
          git config --global user.email "${{ secrets.GITCODE_EMAIL }}"
          
          # æ·»åŠ  GitCode è¿œç¨‹ä»“åº“
          git remote add gitcode https://oauth2:${{ secrets.GITCODE_TOKEN }}@gitcode.com/ghost-him/ZeroLaunch-rs.git || true
          
          # æ¨é€ä»£ç å’Œæ ‡ç­¾åˆ° GitCode
          git push gitcode main --tags -f || echo "Failed to push to GitCode"
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITCODE_EMAIL: ${{ secrets.GITCODE_EMAIL }}

      - name: Upload artifacts to GitCode Generic Packages
        if: success()
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $projectId = "ghost-him%2FZeroLaunch-rs"
          $packageName = "releases"
          
          $headers = @{
            "PRIVATE-TOKEN" = "${{ secrets.GITCODE_TOKEN }}"
          }
          
          # è·å–æ‰€æœ‰æ„å»ºäº§ç‰©
          $files = Get-ChildItem -Path . -Include *.exe,*.msi,*.zip -File
          
          foreach ($file in $files) {
            $fileName = $file.Name
            echo "ğŸ“¦ ä¸Šä¼  $fileName åˆ° GitCode Generic Packages..."
            
            try {
              # ä¸Šä¼ åˆ° Generic Package Registry
              # API: PUT /projects/:id/packages/generic/:package_name/:package_version/:file_name
              $uploadUrl = "https://gitcode.com/api/v4/projects/$projectId/packages/generic/$packageName/$version/$fileName"
              
              Invoke-RestMethod -Uri $uploadUrl -Method Put -Headers $headers -InFile $file.FullName
              echo "âœ… å·²ä¸Šä¼ : $fileName"
            } catch {
              echo "âŒ ä¸Šä¼  $fileName å¤±è´¥: $_"
            }
          }
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}

      - name: Create GitCode Release with assets
        if: success()
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $releaseTitle = "${{ steps.get_version.outputs.RELEASE_TITLE }}"
          $tag = "v$version"
          $projectId = "ghost-him%2FZeroLaunch-rs"
          $packageName = "releases"
          
          # ä½¿ç”¨ GitCode API (ç±»ä¼¼ GitLab API)
          $headers = @{
            "Content-Type" = "application/json"
            "PRIVATE-TOKEN" = "${{ secrets.GITCODE_TOKEN }}"
          }
          
          # æ„å»º asset links
          $files = Get-ChildItem -Path . -Include *.exe,*.msi,*.zip -File
          $assetLinks = @()
          
          foreach ($file in $files) {
            $fileName = $file.Name
            $fileUrl = "https://gitcode.com/api/v4/projects/$projectId/packages/generic/$packageName/$version/$fileName"
            
            $assetLinks += @{
              name = $fileName
              url = $fileUrl
              link_type = "package"
            }
          }
          
          $body = @{
            tag_name = $tag
            name = $releaseTitle
            description = "Release $releaseTitle - Auto-generated from GitHub Actions`n`n## ä¸‹è½½é“¾æ¥`n`næ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° Generic Packages"
            assets = @{
              links = $assetLinks
            }
          } | ConvertTo-Json -Depth 10
          
          try {
            # å…ˆå°è¯•åˆ é™¤å·²å­˜åœ¨çš„ Release (å¦‚æœå­˜åœ¨)
            try {
              Invoke-RestMethod -Uri "https://gitcode.com/api/v4/projects/$projectId/releases/$tag" -Method Delete -Headers $headers
              echo "å·²åˆ é™¤æ—§çš„ GitCode Release"
            } catch {
              echo "æ²¡æœ‰æ—§çš„ Release éœ€è¦åˆ é™¤"
            }
            
            # åˆ›å»ºæ–°çš„ Release
            $response = Invoke-RestMethod -Uri "https://gitcode.com/api/v4/projects/$projectId/releases" -Method Post -Headers $headers -Body $body
            echo "âœ… GitCode Release åˆ›å»ºæˆåŠŸ"
            echo "Release URL: https://gitcode.com/ghost-him/ZeroLaunch-rs/-/releases/$tag"
          } catch {
            echo "âŒ åˆ›å»º GitCode Release å¤±è´¥: $_"
            echo "Response: $($_.Exception.Response)"
          }
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}

  notify:
    name: Notify on completion
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify build status
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… Build and release completed successfully!"
          else
            echo "âŒ Build failed!"
            exit 1
          fi
