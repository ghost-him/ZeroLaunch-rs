name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ v1.0.0 æ ¼å¼çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      skip_release:
        description: 'ä»…æ„å»ºï¼Œä¸å‘å¸ƒ Release'
        required: false
        default: true
        type: boolean
      tag:
        description: 'æŒ‡å®šç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚: v0.5.4)ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨ä» git æå–'
        required: false
        type: string

permissions:
  contents: write
  actions: read

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Release
    runs-on: windows-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
      release_title: ${{ steps.get_version.outputs.RELEASE_TITLE }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc,aarch64-pc-windows-msvc

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Copy i18n locales to src-tauri
        shell: pwsh
        run: |
          $srcLocalesDir = "src\i18n\locales"
          $destDir = "src-tauri\locales"
          if (-not (Test-Path $destDir)) {
            New-Item -Path $destDir -ItemType Directory -Force | Out-Null
          }
          Copy-Item -Path "$srcLocalesDir\*" -Destination $destDir -Force
          Write-Host "âœ“ i18n locales files copied to src-tauri/locales/"

      - name: Get version from tag
        id: get_version
        shell: pwsh
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·è¾“å…¥çš„ tag
          $inputTag = "${{ github.event.inputs.tag }}"
          
          if (-not [string]::IsNullOrEmpty($inputTag)) {
            # ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ tag
            $tag = $inputTag -replace '^v', ''
            echo "ğŸ“ ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æ ‡ç­¾: v$tag"
          } else {
            # ä» git ref æå– tag
            $tag = $env:GITHUB_REF -replace 'refs/tags/v', ''
            if ([string]::IsNullOrEmpty($tag)) {
              $tag = "0.0.0"
            }
            echo "ğŸ“ ä» git ref æå–æ ‡ç­¾: v$tag"
          }

          # ç”Ÿæˆ yymmdd æ ¼å¼çš„æ—¥æœŸ
          $date = Get-Date -Format "yyMMdd"
          $releaseTitle = "$date-v$tag"

          echo "VERSION=$tag" >> $env:GITHUB_OUTPUT
          echo "RELEASE_TITLE=$releaseTitle" >> $env:GITHUB_OUTPUT
          echo "Version: $tag"
          echo "Release Title: $releaseTitle"

      - name: Build all variants
        shell: pwsh
        run: |
          cd xtask
          # æ„å»ºæ‰€æœ‰æ¶æ„å’Œ AI å˜ä½“
          cargo run --bin xtask build-all --arch all --ai both
          cd ..

      - name: List build artifacts
        shell: pwsh
        run: |
          echo "=== Build artifacts ==="
          echo "å½“å‰ç›®å½•: $(Get-Location)"
          # åœ¨æ ¹ç›®å½•æŸ¥æ‰¾æ„å»ºäº§ç‰©ï¼ˆä¸é€’å½’ï¼Œå› ä¸º xtask ä¼šå°†æ–‡ä»¶ç§»åŠ¨åˆ°æ ¹ç›®å½•ï¼‰
          $files = Get-ChildItem -Path . -File | Where-Object { $_.Extension -in '.exe', '.msi', '.zip' }
          if ($files.Count -eq 0) {
            echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ„å»ºäº§ç‰©ï¼"
            echo "æ ¹ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼š"
            Get-ChildItem -Path . -File | Select-Object -First 30 | ForEach-Object { 
              echo "  - $($_.Name) ($($_.Extension))" 
            }
            exit 1
          }
          echo "æ‰¾åˆ° $($files.Count) ä¸ªæ„å»ºäº§ç‰©ï¼š"
          $files | ForEach-Object {
            $sizeMB = [math]::Round($_.Length / 1MB, 2)
            echo "  âœ… $($_.Name) ($sizeMB MB)"
          }

      # ==========================================
      # SignPath ä»£ç ç­¾åé›†æˆ
      # ==========================================

      - name: Package artifacts for signing
        id: package-artifacts
        shell: pwsh
        run: |
          echo "ğŸ“¦ æ‰“åŒ…æ„å»ºäº§ç‰©ç”¨äºç­¾å..."

          # åˆ›å»ºä¸´æ—¶ç›®å½•
          $bundleDir = "signing-artifacts"
          New-Item -Path $bundleDir -ItemType Directory -Force | Out-Null

          # å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©åˆ°ä¸´æ—¶ç›®å½•
          $files = Get-ChildItem -Path . -File | Where-Object { $_.Extension -in '.exe', '.msi', '.zip' }
          foreach ($file in $files) {
            Copy-Item -Path $file.FullName -Destination $bundleDir -Force
            echo "  âœ“ å·²æ·»åŠ : $($file.Name)"
          }

          echo "âœ… å…±æ‰“åŒ… $($files.Count) ä¸ªæ–‡ä»¶"

      - name: Upload unsigned artifacts to GitHub
        id: upload-unsigned-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-artifacts
          path: signing-artifacts/*
          if-no-files-found: error
          retention-days: 7

      - name: Submit to SignPath for code signing
        id: submit-signing-request
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
          organization-id: '${{ secrets.SIGNPATH_ORGANIZATION_ID }}'
          project-slug: '${{ secrets.SIGNPATH_PROJECT_SLUG }}'
          signing-policy-slug: '${{ secrets.SIGNPATH_SIGNING_POLICY_SLUG }}'
          artifact-configuration-slug: 'zerolaunch-rs-release'
          github-artifact-id: '${{ steps.upload-unsigned-artifacts.outputs.artifact-id }}'
          wait-for-completion: true
          output-artifact-directory: 'signed-artifacts'
          wait-for-completion-timeout-in-seconds: 1800
          parameters: |
            version: "${{ steps.get_version.outputs.VERSION }}"

      - name: List signed artifacts
        shell: pwsh
        run: |
          echo "=== å·²ç­¾åçš„æ„å»ºäº§ç‰© ==="
          if (Test-Path "signed-artifacts") {
            $signedFiles = Get-ChildItem -Path "signed-artifacts" -File -Recurse | Where-Object { $_.Extension -in '.exe', '.msi', '.zip' }
            if ($signedFiles.Count -eq 0) {
              echo "âŒ é”™è¯¯ï¼šç­¾åç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ–‡ä»¶ï¼"
              exit 1
            }
            echo "æ‰¾åˆ° $($signedFiles.Count) ä¸ªå·²ç­¾åæ–‡ä»¶ï¼š"
            $signedFiles | ForEach-Object {
              $sizeMB = [math]::Round($_.Length / 1MB, 2)
              echo "  âœ… $($_.Name) ($sizeMB MB)"
            }
          } else {
            echo "âŒ é”™è¯¯ï¼šç­¾åè¾“å‡ºç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          }

      - name: Move signed artifacts to root
        shell: pwsh
        run: |
          echo "ğŸ“¦ ç§»åŠ¨å·²ç­¾åæ–‡ä»¶åˆ°æ ¹ç›®å½•..."

          # åˆ é™¤åŸæœ‰çš„æœªç­¾åæ–‡ä»¶
          Get-ChildItem -Path . -File | Where-Object { $_.Extension -in '.exe', '.msi', '.zip' } | Remove-Item -Force

          # ç§»åŠ¨å·²ç­¾åæ–‡ä»¶åˆ°æ ¹ç›®å½•
          Get-ChildItem -Path "signed-artifacts" -File -Recurse | Where-Object { $_.Extension -in '.exe', '.msi', '.zip' } | ForEach-Object {
            Move-Item -Path $_.FullName -Destination . -Force
            echo "  âœ“ $($_.Name)"
          }

          # æ¸…ç†ä¸´æ—¶ç›®å½•
          Remove-Item -Path "signing-artifacts" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "signed-artifacts" -Recurse -Force -ErrorAction SilentlyContinue

          echo "âœ… å·²ç­¾åæ–‡ä»¶å·²å°±ç»ª"

      - name: Generate Release Notes
        id: release_notes
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $tag = "v$version"
          $repoPath = "${{ github.repository }}"

          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          $previousTag = git describe --tags --abbrev=0 "$tag^" 2>$null
          if ([string]::IsNullOrEmpty($previousTag)) {
            $previousTag = git rev-list --max-parents=0 HEAD
          }

          # ç”Ÿæˆæ ¼å¼åŒ–çš„å˜æ›´æ—¥å¿—
          $commits = (git log "$previousTag..$tag" --pretty=format:"* %s (`%h`)" --no-merges 2>$null) -join "`n"
          if ([string]::IsNullOrEmpty($commits)) {
            $commits = (git log -10 --pretty=format:"* %s (`%h`)" --no-merges) -join "`n"
          }

          # è·å–è´¡çŒ®è€…åˆ—è¡¨
          $contributors = (git log "$previousTag..$tag" --pretty=format:"%an" --no-merges 2>$null | Sort-Object -Unique)
          if ($contributors.Count -eq 0) {
            $contributors = (git log -10 --pretty=format:"%an" --no-merges | Sort-Object -Unique)
          }
          $contributorsList = ($contributors | ForEach-Object { "* @$_" }) -join "`n"

          # æ„å»ºç²¾ç®€åçš„ç‰ˆæœ¬è¯´æ˜
          $versionGuide = @"
          ## ğŸ“¦ ç‰ˆæœ¬è¯´æ˜

          - **å®‰è£…ç‰ˆ (`.exe`/`.msi`)**: æä¾›ä¼ ç»Ÿçš„å®‰è£…ä½“éªŒã€‚
          - **ä¾¿æºç‰ˆ (`.zip`)**: æ— éœ€å®‰è£…ï¼Œè§£å‹å³ç”¨ï¼Œé€‚åˆç§»åŠ¨æˆ–ç»¿è‰²ç‰ˆçˆ±å¥½è€…ã€‚

          > **å®Œæ•´ç‰ˆ**åŒ…å« AI æ™ºèƒ½æœç´¢åŠŸèƒ½ï¼Œè€Œ **ç²¾ç®€ç‰ˆ (lite)** ä¸å« AI åŠŸèƒ½ï¼Œä½“ç§¯æ›´å°ã€‚

          ---

          ### ğŸ¤– å…³äº AI åŠŸèƒ½

          > **é‡è¦æç¤º**ï¼šAI æ™ºèƒ½æœç´¢åŠŸèƒ½éœ€è¦å•ç‹¬ä¸‹è½½æ¨¡å‹æƒé‡æ–‡ä»¶æ‰èƒ½ä½¿ç”¨ã€‚

          **æ¨¡å‹ä¸‹è½½åœ°å€**ï¼š
          - GitHub: https://github.com/$repoPath/releases/tag/model
          - Gitee: https://gitee.com/$repoPath/releases/tag/model
          - GitCode: https://gitcode.com/$repoPath/releases/model

          è¯·æ ¹æ®æ¨¡å‹å‘å¸ƒé¡µä¸­çš„è¯´æ˜è¿›è¡Œé…ç½®ã€‚
          "@

          # æ„å»ºæœ€ç»ˆçš„ Release Notes
          $changelogUrl = "https://github.com/$repoPath/compare/$previousTag...$tag"
          $releaseNotes = @"

          ## What's Changed

          $commits

          ## Contributors

          $contributorsList

          **Full Changelog**: $changelogUrl

          $versionGuide
          "@

          # è¾“å‡ºåˆ°æ–‡ä»¶
          $releaseNotes | Out-File -FilePath "release_notes.txt" -Encoding UTF8
          echo "RELEASE_NOTES_FILE=release_notes.txt" >> $env:GITHUB_OUTPUT
          echo "Generated release notes"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: |
            *.exe
            *.msi
            *.zip
            release_notes.txt
          if-no-files-found: error
          retention-days: 7

  # =======================================================
  # ç‹¬ç«‹çš„ GitHub Release Job
  # =======================================================
  release-github:
    name: Publish to GitHub
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_release == 'false')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets
          path: .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.build.outputs.release_title }}
          body_path: release_notes.txt
          files: |
            *.exe
            *.msi
            *.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =======================================================
  # ç‹¬ç«‹çš„ Gitee Release Job (å¸¦é‡è¯•æœºåˆ¶)
  # =======================================================
  release-gitee:
    name: Publish to Gitee
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_release == 'false')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets
          path: .

      - name: Push to Gitee
        shell: pwsh
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_EMAIL: ${{ secrets.GITEE_EMAIL }}
        run: |
          $owner, $repo = "${{ github.repository }}".Split('/')
          git config --global user.name "ghost-him"
          git config --global user.email "$env:GITEE_EMAIL"
          git remote add gitee "https://oauth2:$($env:GITEE_TOKEN)@gitee.com/$owner/$repo.git" || true
          git push gitee HEAD:main --tags -f

      - name: Create Gitee Release with Retry
        shell: pwsh
        env:
          VERSION: ${{ needs.build.outputs.version }}
          RELEASE_TITLE: ${{ needs.build.outputs.release_title }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          # --- é‡è¯•æœºåˆ¶é…ç½® ---
          $maxRetries = 3
          $retryDelaySeconds = 20
          # --------------------

          # åŠ¨æ€è·å–ä»“åº“æ‰€æœ‰è€…å’Œåç§°
          $owner, $repo = "${{ github.repository }}".Split('/')
          Write-Host "Target Gitee Repository: $owner/$repo"

          for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              Write-Host "Attempt $i of $maxRetries to create and upload Gitee release..."

              $version = $env:VERSION
              $releaseTitle = $env:RELEASE_TITLE
              $tag = "v$version"
              $releaseNotes = Get-Content -Path "release_notes.txt" -Raw -Encoding UTF8
              $headers = @{"Content-Type" = "application/json"; "Authorization" = "token $env:GITEE_TOKEN"}
              $body = @{tag_name = $tag; name = $releaseTitle; body = $releaseNotes; target_commitish = "main"; prerelease = $false} | ConvertTo-Json

              # ç¡®ä¿å¹‚ç­‰æ€§ï¼šå…ˆåˆ é™¤æ—§ Release
              try {
                $existingRelease = Invoke-RestMethod -Uri "https://gitee.com/api/v5/repos/$owner/$repo/releases/tags/$tag" -Method Get -Headers $headers -ErrorAction SilentlyContinue
                if ($existingRelease) {
                  Invoke-RestMethod -Uri "https://gitee.com/api/v5/repos/$owner/$repo/releases/$($existingRelease.id)" -Method Delete -Headers $headers
                  Write-Host "å·²åˆ é™¤æ—§çš„ Gitee Release"
                }
              } catch { Write-Host "æ²¡æœ‰æ—§çš„ Gitee Release éœ€è¦åˆ é™¤" }

              # åˆ›å»ºæ–° Release
              $response = Invoke-RestMethod -Uri "https://gitee.com/api/v5/repos/$owner/$repo/releases" -Method Post -Headers $headers -Body $body
              $releaseId = $response.id
              Write-Host "âœ… Gitee Release åˆ›å»ºæˆåŠŸï¼ŒID: $releaseId"

              # ä¸Šä¼ æ–‡ä»¶
              $files = Get-ChildItem -Path . -Recurse -Include *.exe,*.msi,*.zip -File
              if ($files.Count -eq 0) { throw "æœªæ‰¾åˆ°éœ€è¦ä¸Šä¼ åˆ° Gitee çš„æ„å»ºäº§ç‰©" }

              foreach ($file in $files) {
                Write-Host "ğŸ“¦ æ­£åœ¨ä¸Šä¼  $($file.Name) åˆ° Gitee Release..."
                curl.exe -X POST "https://gitee.com/api/v5/repos/$owner/$repo/releases/$releaseId/attach_files" -F "access_token=$env:GITEE_TOKEN" -F "file=@$($file.FullName)"
                if ($LASTEXITCODE -ne 0) {
                  throw "ä¸Šä¼ æ–‡ä»¶ $($file.Name) åˆ° Gitee å¤±è´¥"
                }
                Write-Host "âœ… å·²ä¸Šä¼ : $($file.Name)"
              }

              Write-Host "âœ… Gitee Release æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
              break # æˆåŠŸåˆ™è·³å‡ºå¾ªç¯
            } catch {
              Write-Host "âŒ Gitee Release æ“ä½œå¤±è´¥: $_"
              if ($i -lt $maxRetries) {
                Write-Host "å°†åœ¨ $retryDelaySeconds ç§’åé‡è¯•..."
                Start-Sleep -Seconds $retryDelaySeconds
              } else {
                Write-Host "âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ŒGitee å‘å¸ƒå¤±è´¥ã€‚"
                throw # æœ€åä¸€æ¬¡å¤±è´¥æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ä»¥ä½¿ job å¤±è´¥
              }
            }
          }

  # =======================================================
  # ç‹¬ç«‹çš„ GitCode Release Job (å¸¦é‡è¯•æœºåˆ¶)
  # =======================================================
  release-gitcode:
    name: Publish to GitCode
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_release == 'false')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets
          path: .

      - name: Push to GitCode
        shell: pwsh
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITCODE_EMAIL: ${{ secrets.GITCODE_EMAIL }}
        run: |
          $owner, $repo = "${{ github.repository }}".Split('/')
          git config --global user.name "ghost-him"
          git config --global user.email "$env:GITCODE_EMAIL"
          git remote add gitcode "https://oauth2:$($env:GITCODE_TOKEN)@gitcode.com/$owner/$repo.git" || true
          git push gitcode HEAD:main --tags -f
      - name: Create GitCode Release with Retry
        shell: pwsh
        env:
          VERSION: ${{ needs.build.outputs.version }}
          RELEASE_TITLE: ${{ needs.build.outputs.release_title }}
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
        run: |
          # --- é‡è¯•æœºåˆ¶é…ç½® ---
          $maxRetries = 3
          $retryDelaySeconds = 30 # GitCode API å¯èƒ½æ›´æ…¢ï¼Œå»¶è¿Ÿç¨é•¿
          # --------------------

          # åŠ¨æ€è·å–ä»“åº“æ‰€æœ‰è€…å’Œåç§°
          $owner, $repo = "${{ github.repository }}".Split('/')
          Write-Host "Target GitCode Repository: $owner/$repo"

          for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              Write-Host "Attempt $i of $maxRetries to create and upload GitCode release..."

              $version = $env:VERSION
              $releaseTitle = $env:RELEASE_TITLE
              $tag = "v$version"
              $token = $env:GITCODE_TOKEN
              $releaseNotes = Get-Content -Path "release_notes.txt" -Raw -Encoding UTF8
              $headers = @{"Private-Token" = $token}

              # 1. åˆ›å»º Release
              $createReleaseUri = "https://gitcode.com/api/v5/repos/$owner/$repo/releases"
              $releaseBody = @{tag_name = $tag; name = $releaseTitle; body = $releaseNotes} | ConvertTo-Json -Depth 5
              Invoke-RestMethod -Uri $createReleaseUri -Method Post -Headers $headers -ContentType "application/json" -Body $releaseBody -ErrorAction Stop
              Write-Host "âœ… GitCode Release åˆ›å»ºæˆåŠŸ"

              # 2. ä¸Šä¼ æ–‡ä»¶
              $files = Get-ChildItem -Path . -Recurse -Include *.exe,*.msi,*.zip -File
              if ($files.Count -eq 0) { throw "æœªæ‰¾åˆ°éœ€è¦ä¸Šä¼ åˆ° GitCode çš„æ„å»ºäº§ç‰©" }

              foreach ($file in $files) {
                Write-Host "ğŸ“¦ æ­£åœ¨ä¸Šä¼  $($file.Name) åˆ° GitCode Release..."
                $encodedFileName = [System.Web.HttpUtility]::UrlEncode($file.Name)
                $getUploadUrlEndpoint = "https://gitcode.com/api/v5/repos/$owner/$repo/releases/$tag/upload_url?access_token=$token&file_name=$encodedFileName"
                $uploadInfo = Invoke-RestMethod -Uri $getUploadUrlEndpoint -Method Get -ErrorAction Stop

                if (-not $uploadInfo.url) { throw "æœªä» GitCode è·å–åˆ°ä¸Šä¼ åœ°å€" }

                $putHeaders = @{}
                if ($uploadInfo.headers) {
                  foreach ($key in $uploadInfo.headers.PSObject.Properties.Name) { $putHeaders[$key] = $uploadInfo.headers.$key }
                }

                Invoke-RestMethod -Uri $uploadInfo.url -Method Put -InFile $file.FullName -Headers $putHeaders -ErrorAction Stop
                Write-Host "âœ… å·²ä¸Šä¼ : $($file.Name)"
              }

              Write-Host "âœ… GitCode Release æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
              break # æˆåŠŸåˆ™è·³å‡ºå¾ªç¯
            } catch {
              Write-Host "âŒ GitCode Release æ“ä½œå¤±è´¥: $($_.Exception.Message)"
              if ($i -lt $maxRetries) {
                Write-Host "å°†åœ¨ $retryDelaySeconds ç§’åé‡è¯•..."
                Start-Sleep -Seconds $retryDelaySeconds
              } else {
                Write-Host "âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ŒGitCode å‘å¸ƒå¤±è´¥ã€‚"
                throw # æœ€åä¸€æ¬¡å¤±è´¥æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ä»¥ä½¿ job å¤±è´¥
              }
            }
          }

  # =======================================================
  # æœ€ç»ˆçš„é€šçŸ¥ Job,ä¾èµ–äºæ‰€æœ‰å¹¶è¡Œçš„ release job
  # =======================================================
  notify:
    name: Notify on completion
    needs:
      - release-github
      - release-gitee
      - release-gitcode
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_release == 'false')
    # æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¿è¡Œ,ä½†æ‰‹åŠ¨è§¦å‘æ—¶ä¸è¿è¡Œ
    steps:
      - name: Check status of all release jobs
        run: |
          echo "ğŸ” Checking status of all release jobs..."
          
          github_status="${{ needs.release-github.result }}"
          gitee_status="${{ needs.release-gitee.result }}"
          gitcode_status="${{ needs.release-gitcode.result }}"
          
          echo "  - GitHub Release: $github_status"
          echo "  - Gitee Release:  $gitee_status"
          echo "  - GitCode Release: $gitcode_status"

          if [[ "$github_status" == "success" && "$gitee_status" == "success" && "$gitcode_status" == "success" ]]; then
            echo "âœ… All platforms released successfully!"
          else
            echo "âŒ One or more platforms failed to release. Please check the logs."
            exit 1
          fi