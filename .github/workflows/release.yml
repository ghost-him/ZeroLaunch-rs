name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ v1.0.0 æ ¼å¼çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Release
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc,aarch64-pc-windows-msvc

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Copy i18n locales to src-tauri
        shell: pwsh
        run: |
          $srcLocalesDir = "src\i18n\locales"
          $destDir = "src-tauri\locales"
          if (-not (Test-Path $destDir)) {
            New-Item -Path $destDir -ItemType Directory -Force | Out-Null
          }
          Copy-Item -Path "$srcLocalesDir\*" -Destination $destDir -Force
          Write-Host "âœ“ i18n locales files copied to src-tauri/locales/"

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Get version from tag
        id: get_version
        shell: pwsh
        run: |
          $tag = $env:GITHUB_REF -replace 'refs/tags/v', ''
          if ([string]::IsNullOrEmpty($tag)) {
            $tag = "0.0.0"
          }
          
          # ç”Ÿæˆ yymmdd æ ¼å¼çš„æ—¥æœŸ
          $date = Get-Date -Format "yyMMdd"
          $releaseTitle = "$date-v$tag"
          
          echo "VERSION=$tag" >> $env:GITHUB_OUTPUT
          echo "RELEASE_TITLE=$releaseTitle" >> $env:GITHUB_OUTPUT
          echo "Version: $tag"
          echo "Release Title: $releaseTitle"

      - name: Build all variants
        shell: pwsh
        run: |
          cd xtask
          # æ„å»ºæ‰€æœ‰æ¶æ„å’Œ AI å˜ä½“
          cargo run --bin xtask build-all --arch all --ai both
        
      - name: List build artifacts
        shell: pwsh
        run: |
          echo "=== Build artifacts ==="
          $files = Get-ChildItem -Path . -Include *.exe,*.msi,*.zip -File
          if ($files.Count -eq 0) {
            echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ„å»ºäº§ç‰©ï¼"
            exit 1
          }
          echo "æ‰¾åˆ° $($files.Count) ä¸ªæ„å»ºäº§ç‰©ï¼š"
          $files | ForEach-Object {
            $sizeMB = [math]::Round($_.Length / 1MB, 2)
            echo "  âœ… $($_.Name) ($sizeMB MB)"
          }

      - name: Generate Release Notes
        id: release_notes
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $tag = "v$version"
          
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          $previousTag = git describe --tags --abbrev=0 "$tag^" 2>$null
          if ([string]::IsNullOrEmpty($previousTag)) {
            $previousTag = git rev-list --max-parents=0 HEAD
          }
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          $commits = git log "$previousTag..$tag" --pretty=format:"* %s (%h)" --no-merges 2>$null
          if ([string]::IsNullOrEmpty($commits)) {
            $commits = git log -10 --pretty=format:"* %s (%h)" --no-merges
          }
          
          # è·å–è´¡çŒ®è€…åˆ—è¡¨
          $contributors = git log "$previousTag..$tag" --pretty=format:"%an" --no-merges 2>$null | Sort-Object -Unique
          if ([string]::IsNullOrEmpty($contributors)) {
            $contributors = git log -10 --pretty=format:"%an" --no-merges | Sort-Object -Unique
          }
          
          # æ„å»º Release Notes
          $contributorsList = ($contributors | ForEach-Object { "* $_" }) -join "`n"
          $changelogUrl = "https://github.com/ghost-him/ZeroLaunch-rs/compare/$previousTag...$tag"
          
          $releaseNotes = "## What's Changed`n`n$commits`n`n## Contributors`n`n$contributorsList`n`n**Full Changelog**: $changelogUrl"
          
          # è¾“å‡ºåˆ°æ–‡ä»¶ï¼Œé¿å…å¤šè¡Œå­—ç¬¦ä¸²åœ¨ GitHub Actions ä¸­çš„é—®é¢˜
          $releaseNotes | Out-File -FilePath "release_notes.txt" -Encoding UTF8
          echo "RELEASE_NOTES_FILE=release_notes.txt" >> $env:GITHUB_OUTPUT
          echo "Generated release notes"

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.get_version.outputs.RELEASE_TITLE }}
          files: |
            *.exe
            *.msi
            *.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Gitee
        if: success()
        shell: pwsh
        run: |
          # é…ç½® Gitee
          git config --global user.name "ghost-him"
          git config --global user.email "${{ secrets.GITEE_EMAIL }}"
          
          # æ·»åŠ  Gitee è¿œç¨‹ä»“åº“
          git remote add gitee https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/ghost-him/ZeroLaunch-rs.git || true
          
          # æ¨é€ä»£ç å’Œæ ‡ç­¾åˆ° Gitee
          git push gitee main --tags -f || echo "Failed to push to Gitee"
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_EMAIL: ${{ secrets.GITEE_EMAIL }}

      - name: Create Gitee Release
        if: success()
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $releaseTitle = "${{ steps.get_version.outputs.RELEASE_TITLE }}"
          $tag = "v$version"
          
          # è¯»å–ç”Ÿæˆçš„ Release Notes
          $releaseNotes = Get-Content -Path "release_notes.txt" -Raw -Encoding UTF8
          
          # ä½¿ç”¨ Gitee API åˆ›å»º Release
          $headers = @{
            "Content-Type" = "application/json"
            "Authorization" = "token ${{ secrets.GITEE_TOKEN }}"
          }
          
          $body = @{
            tag_name = $tag
            name = $releaseTitle
            body = $releaseNotes
            prerelease = $false
          } | ConvertTo-Json
          
          try {
            # å…ˆå°è¯•åˆ é™¤æ—§çš„ Releaseï¼Œç¡®ä¿å¹‚ç­‰æ€§
            try {
              $deleteResponse = Invoke-RestMethod -Uri "https://gitee.com/api/v5/repos/ghost-him/ZeroLaunch-rs/releases/tags/$tag" -Method Get -Headers $headers -ErrorAction SilentlyContinue
              if ($deleteResponse) {
                Invoke-RestMethod -Uri "https://gitee.com/api/v5/repos/ghost-him/ZeroLaunch-rs/releases/$($deleteResponse.id)" -Method Delete -Headers $headers
                echo "å·²åˆ é™¤æ—§çš„ Gitee Release"
              }
            } catch {
              echo "æ²¡æœ‰æ—§çš„ Gitee Release éœ€è¦åˆ é™¤"
            }
            
            # åˆ›å»ºæ–°çš„ Release
            $response = Invoke-RestMethod -Uri "https://gitee.com/api/v5/repos/ghost-him/ZeroLaunch-rs/releases" -Method Post -Headers $headers -Body $body
            $releaseId = $response.id
            echo "âœ… Gitee Release åˆ›å»ºæˆåŠŸï¼ŒID: $releaseId"
            
            # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Gitee Release
            $files = Get-ChildItem -Path . -Include *.exe,*.msi,*.zip -File
            foreach ($file in $files) {
              echo "ğŸ“¦ æ­£åœ¨ä¸Šä¼  $($file.Name) åˆ° Gitee Release..."
              $uploadUrl = "https://gitee.com/api/v5/repos/ghost-him/ZeroLaunch-rs/releases/$releaseId/attach_files?access_token=${{ secrets.GITEE_TOKEN }}"
              
              # ä½¿ç”¨ curl ä¸Šä¼ æ–‡ä»¶ï¼ˆæ›´å¯é ï¼‰
              curl.exe -X POST $uploadUrl -F "file=@$($file.FullName)" --silent --show-error
              
              if ($LASTEXITCODE -eq 0) {
                echo "âœ… å·²ä¸Šä¼ : $($file.Name)"
              } else {
                echo "âŒ ä¸Šä¼ å¤±è´¥: $($file.Name)"
                throw "Failed to upload $($file.Name) to Gitee"
              }
            }
            
            echo "âœ… Gitee Release æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
          } catch {
            echo "âŒ Gitee Release åˆ›å»ºæˆ–ä¸Šä¼ å¤±è´¥: $_"
            throw
          }
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}

      - name: Upload to GitCode
        if: success()
        shell: pwsh
        run: |
          # é…ç½® GitCode
          git config --global user.name "ghost-him"
          git config --global user.email "${{ secrets.GITCODE_EMAIL }}"
          
          # æ·»åŠ  GitCode è¿œç¨‹ä»“åº“
          git remote add gitcode https://oauth2:${{ secrets.GITCODE_TOKEN }}@gitcode.com/ghost-him/ZeroLaunch-rs.git || true
          
          # æ¨é€ä»£ç å’Œæ ‡ç­¾åˆ° GitCode
          git push gitcode main --tags -f || echo "Failed to push to GitCode"
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITCODE_EMAIL: ${{ secrets.GITCODE_EMAIL }}

      - name: Create and Upload to GitCode Release
        if: success()
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $releaseTitle = "${{ steps.get_version.outputs.RELEASE_TITLE }}"
          $tag = "v$version"
          $projectId = "ghost-him%2FZeroLaunch-rs" # æ³¨æ„è¿™é‡Œéœ€è¦ URL ç¼–ç 
          
          # è¯»å–ç”Ÿæˆçš„ Release Notes
          $releaseNotes = Get-Content -Path "release_notes.txt" -Raw -Encoding UTF8
          
          # 1. åˆ›å»º Release (ä¸å¸¦é™„ä»¶)
          # GitCode (GitLab) API éœ€è¦å…ˆåˆ›å»º Releaseï¼Œç„¶åå†é™„åŠ æ–‡ä»¶
          $headers = @{
            "Content-Type" = "application/json"
            "PRIVATE-TOKEN" = "${{ secrets.GITCODE_TOKEN }}"
          }
          
          $releaseBody = @{
            tag_name = $tag
            name = $releaseTitle
            description = $releaseNotes
          } | ConvertTo-Json
          
          try {
            # å…ˆå°è¯•åˆ é™¤æ—§çš„ Releaseï¼Œç¡®ä¿å¹‚ç­‰æ€§
            try {
              Invoke-RestMethod -Uri "https://gitcode.com/api/v4/projects/$projectId/releases/$tag" -Method Delete -Headers $headers -ErrorAction SilentlyContinue
              echo "å·²åˆ é™¤æ—§çš„ GitCode Release"
            } catch {
              echo "æ²¡æœ‰æ—§çš„ GitCode Release éœ€è¦åˆ é™¤"
            }
            
            # åˆ›å»ºæ–°çš„ Release
            Invoke-RestMethod -Uri "https://gitcode.com/api/v4/projects/$projectId/releases" -Method Post -Headers $headers -Body $releaseBody
            echo "âœ… GitCode Release åˆ›å»ºæˆåŠŸ"
          } catch {
            echo "âŒ åˆ›å»º GitCode Release å¤±è´¥: $_"
            exit 1
          }

          # 2. ä¸Šä¼ æ„å»ºäº§ç‰©ä½œä¸º Release çš„é™„ä»¶
          $files = Get-ChildItem -Path . -Include *.exe,*.msi,*.zip -File
          foreach ($file in $files) {
            echo "ğŸ“¦ æ­£åœ¨ä¸Šä¼  $($file.Name) åˆ° GitCode Release..."
            
            # GitCode/GitLab ä¸Šä¼ é™„ä»¶çš„ API æ¯”è¾ƒç‰¹æ®Šï¼Œéœ€è¦å…ˆå°†æ–‡ä»¶ä¸Šä¼ åˆ°é¡¹ç›®ï¼Œè·å–é“¾æ¥ï¼Œå†å°†é“¾æ¥é™„åŠ åˆ° Release
            try {
              $uploadUrl = "https://gitcode.com/api/v4/projects/$projectId/uploads"
              $uploadHeaders = @{
                "PRIVATE-TOKEN" = "${{ secrets.GITCODE_TOKEN }}"
              }
              
              # ä½¿ç”¨ curl ä¸Šä¼ æ–‡ä»¶ï¼ŒInvoke-RestMethod å¯¹ multipart/form-data æ”¯æŒä¸ä½³
              $responseJson = curl.exe -s -X POST -H "PRIVATE-TOKEN: ${{ secrets.GITCODE_TOKEN }}" -F "file=@$($file.FullName)" $uploadUrl
              $responseObj = $responseJson | ConvertFrom-Json
              
              # è·å–ä¸Šä¼ åçš„æ–‡ä»¶é“¾æ¥
              $fileUrl = $responseObj.url
              $fileName = $responseObj.alt
              
              # å°†ä¸Šä¼ åçš„æ–‡ä»¶é“¾æ¥é™„åŠ åˆ° Release
              $linkBody = @{
                name = $fileName
                url = "https://gitcode.com/ghost-him/ZeroLaunch-rs$($fileUrl)" # éœ€è¦æ‹¼æ¥æˆå®Œæ•´ URL
              } | ConvertTo-Json
              
              $attachUrl = "https://gitcode.com/api/v4/projects/$projectId/releases/$tag/assets/links"
              Invoke-RestMethod -Uri $attachUrl -Method Post -Headers $headers -Body $linkBody
              
              echo "âœ… å·²ä¸Šä¼ å¹¶é™„åŠ : $($file.Name)"
            } catch {
              echo "âŒ ä¸Šä¼ æˆ–é™„åŠ  $($file.Name) å¤±è´¥: $_"
              throw "Failed to upload $($file.Name) to GitCode"
            }
          }
          
          echo "âœ… GitCode Release æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}

  notify:
    name: Notify on completion
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify build status
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… Build and release completed successfully!"
          else
            echo "âŒ Build failed!"
            exit 1
          fi
