name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ v1.0.0 æ ¼å¼çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Release
    runs-on: windows-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
      release_title: ${{ steps.get_version.outputs.RELEASE_TITLE }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc,aarch64-pc-windows-msvc

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Copy i18n locales to src-tauri
        shell: pwsh
        run: |
          $srcLocalesDir = "src\i18n\locales"
          $destDir = "src-tauri\locales"
          if (-not (Test-Path $destDir)) {
            New-Item -Path $destDir -ItemType Directory -Force | Out-Null
          }
          Copy-Item -Path "$srcLocalesDir\*" -Destination $destDir -Force
          Write-Host "âœ“ i18n locales files copied to src-tauri/locales/"

      - name: Get version from tag
        id: get_version
        shell: pwsh
        run: |
          $tag = $env:GITHUB_REF -replace 'refs/tags/v', ''
          if ([string]::IsNullOrEmpty($tag)) {
            $tag = "0.0.0"
          }
          
          # ç”Ÿæˆ yymmdd æ ¼å¼çš„æ—¥æœŸ
          $date = Get-Date -Format "yyMMdd"
          $releaseTitle = "$date-v$tag"
          
          echo "VERSION=$tag" >> $env:GITHUB_OUTPUT
          echo "RELEASE_TITLE=$releaseTitle" >> $env:GITHUB_OUTPUT
          echo "Version: $tag"
          echo "Release Title: $releaseTitle"

      - name: Build all variants
        shell: pwsh
        run: |
          cd xtask
          # æ„å»ºæ‰€æœ‰æ¶æ„å’Œ AI å˜ä½“
          cargo run --bin xtask build-all --arch all --ai both
          cd ..
        
      - name: List build artifacts
        shell: pwsh
        run: |
          echo "=== Build artifacts ==="
          echo "å½“å‰ç›®å½•: $(Get-Location)"
          # åœ¨æ ¹ç›®å½•æŸ¥æ‰¾æ„å»ºäº§ç‰©ï¼ˆä¸é€’å½’ï¼Œå› ä¸º xtask ä¼šå°†æ–‡ä»¶ç§»åŠ¨åˆ°æ ¹ç›®å½•ï¼‰
          $files = Get-ChildItem -Path . -File | Where-Object { $_.Extension -in '.exe', '.msi', '.zip' }
          if ($files.Count -eq 0) {
            echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ„å»ºäº§ç‰©ï¼"
            echo "æ ¹ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼š"
            Get-ChildItem -Path . -File | Select-Object -First 30 | ForEach-Object { 
              echo "  - $($_.Name) ($($_.Extension))" 
            }
            exit 1
          }
          echo "æ‰¾åˆ° $($files.Count) ä¸ªæ„å»ºäº§ç‰©ï¼š"
          $files | ForEach-Object {
            $sizeMB = [math]::Round($_.Length / 1MB, 2)
            echo "  âœ… $($_.Name) ($sizeMB MB)"
          }

      - name: Generate Release Notes
        id: release_notes
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $tag = "v$version"
          
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          $previousTag = git describe --tags --abbrev=0 "$tag^" 2>$null
          if ([string]::IsNullOrEmpty($previousTag)) {
            $previousTag = git rev-list --max-parents=0 HEAD
          }
          
          # ç”Ÿæˆæ ¼å¼åŒ–çš„å˜æ›´æ—¥å¿—
          $commits = (git log "$previousTag..$tag" --pretty=format:"* %s (`%h`)" --no-merges 2>$null) -join "`n"
          if ([string]::IsNullOrEmpty($commits)) {
            $commits = (git log -10 --pretty=format:"* %s (`%h`)" --no-merges) -join "`n"
          }
          
          # è·å–è´¡çŒ®è€…åˆ—è¡¨
          $contributors = (git log "$previousTag..$tag" --pretty=format:"%an" --no-merges 2>$null | Sort-Object -Unique)
          if ($contributors.Count -eq 0) {
            $contributors = (git log -10 --pretty=format:"%an" --no-merges | Sort-Object -Unique)
          }
          $contributorsList = ($contributors | ForEach-Object { "* @$_" }) -join "`n"
          
          # æ„å»ºç²¾ç®€åçš„ç‰ˆæœ¬è¯´æ˜
          $versionGuide = @"
          ## ğŸ“¦ ç‰ˆæœ¬è¯´æ˜

          - **å®‰è£…ç‰ˆ (`.exe`/`.msi`)**: æä¾›ä¼ ç»Ÿçš„å®‰è£…ä½“éªŒã€‚
          - **ä¾¿æºç‰ˆ (`.zip`)**: æ— éœ€å®‰è£…ï¼Œè§£å‹å³ç”¨ï¼Œé€‚åˆç§»åŠ¨æˆ–ç»¿è‰²ç‰ˆçˆ±å¥½è€…ã€‚

          > **å®Œæ•´ç‰ˆ**åŒ…å« AI æ™ºèƒ½æœç´¢åŠŸèƒ½ï¼Œè€Œ **ç²¾ç®€ç‰ˆ (lite)** ä¸å« AI åŠŸèƒ½ï¼Œä½“ç§¯æ›´å°ã€‚

          ---
          
          ### ğŸ¤– å…³äº AI åŠŸèƒ½
          
          > **é‡è¦æç¤º**ï¼šAI æ™ºèƒ½æœç´¢åŠŸèƒ½éœ€è¦å•ç‹¬ä¸‹è½½æ¨¡å‹æƒé‡æ–‡ä»¶æ‰èƒ½ä½¿ç”¨ã€‚
          
          **æ¨¡å‹ä¸‹è½½åœ°å€**ï¼š
          - GitHub: https://github.com/ghost-him/ZeroLaunch-rs/releases/tag/model
          - Gitee: https://gitee.com/ghost-him/ZeroLaunch-rs/releases/tag/model
          - GitCode: https://gitcode.com/ghost-him/ZeroLaunch-rs/releases/model
          
          è¯·æ ¹æ®æ¨¡å‹å‘å¸ƒé¡µä¸­çš„è¯´æ˜è¿›è¡Œé…ç½®ã€‚
          "@

          # æ„å»ºæœ€ç»ˆçš„ Release Notes
          $changelogUrl = "https://github.com/ghost-him/ZeroLaunch-rs/compare/$previousTag...$tag"
          $releaseNotes = @"
          $versionGuide

          ## What's Changed

          $commits

          ## Contributors

          $contributorsList

          **Full Changelog**: $changelogUrl
          "@
          
          # è¾“å‡ºåˆ°æ–‡ä»¶
          $releaseNotes | Out-File -FilePath "release_notes.txt" -Encoding UTF8
          echo "RELEASE_NOTES_FILE=release_notes.txt" >> $env:GITHUB_OUTPUT
          echo "Generated release notes"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: |
            *.exe
            *.msi
            *.zip
          if-no-files-found: error
          retention-days: 7

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release_notes.txt
          if-no-files-found: error
          retention-days: 7

  release:
    name: Publish Release
    needs: build
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-packages
          path: .

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - name: List downloaded artifacts
        shell: pwsh
        run: |
          echo "=== Downloaded artifacts ==="
          $files = Get-ChildItem -Path . -File | Where-Object { $_.Extension -in '.exe', '.msi', '.zip', '.txt' }
          if ($files.Count -eq 0) {
            echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä¸‹è½½çš„æ„å»ºäº§ç‰©æˆ–è¯´æ˜æ–‡ä»¶ï¼"
            exit 1
          }
          $files | ForEach-Object {
            $sizeMB = [math]::Round($_.Length / 1MB, 2)
            echo "  âœ… $($_.Name) ($sizeMB MB)"
          }

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.build.outputs.release_title }}
          body_path: release_notes.txt
          files: |
            *.exe
            *.msi
            *.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Gitee
        if: success()
        shell: pwsh
        run: |
          # é…ç½® Gitee
          git config --global user.name "ghost-him"
          git config --global user.email "$env:GITEE_EMAIL"
          
          # æ·»åŠ  Gitee è¿œç¨‹ä»“åº“
          git remote add gitee "https://oauth2:$($env:GITEE_TOKEN)@gitee.com/ghost-him/ZeroLaunch-rs.git" || true
          
          git checkout main

          # æ¨é€ä»£ç å’Œæ ‡ç­¾åˆ° Gitee
          git push gitee main --tags -f || echo "Failed to push to Gitee"
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_EMAIL: ${{ secrets.GITEE_EMAIL }}

      - name: Create Gitee Release
        if: success()
        shell: pwsh
        env:
          VERSION: ${{ needs.build.outputs.version }}
          RELEASE_TITLE: ${{ needs.build.outputs.release_title }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          $version = $env:VERSION
          $releaseTitle = $env:RELEASE_TITLE
          $tag = "v$version"
          
          # è¯»å–ç”Ÿæˆçš„ Release Notes
          $releaseNotes = Get-Content -Path "release_notes.txt" -Raw -Encoding UTF8
          
          # ä½¿ç”¨ Gitee API åˆ›å»º Release
          $headers = @{
            "Content-Type" = "application/json"
            "Authorization" = "token $env:GITEE_TOKEN"
          }
          
          $body = @{
            tag_name = $tag
            name = $releaseTitle
            body = $releaseNotes
            target_commitish = "main"
            prerelease = $false
          } | ConvertTo-Json
          
          try {
            # å…ˆå°è¯•åˆ é™¤æ—§çš„ Releaseï¼Œç¡®ä¿å¹‚ç­‰æ€§
            try {
              $deleteResponse = Invoke-RestMethod -Uri "https://gitee.com/api/v5/repos/ghost-him/ZeroLaunch-rs/releases/tags/$tag" -Method Get -Headers $headers -ErrorAction SilentlyContinue
              if ($deleteResponse) {
                Invoke-RestMethod -Uri "https://gitee.com/api/v5/repos/ghost-him/ZeroLaunch-rs/releases/$($deleteResponse.id)" -Method Delete -Headers $headers
                echo "å·²åˆ é™¤æ—§çš„ Gitee Release"
              }
            } catch {
              echo "æ²¡æœ‰æ—§çš„ Gitee Release éœ€è¦åˆ é™¤"
            }
            
            # åˆ›å»ºæ–°çš„ Release
            $response = Invoke-RestMethod -Uri "https://gitee.com/api/v5/repos/ghost-him/ZeroLaunch-rs/releases" -Method Post -Headers $headers -Body $body
            $releaseId = $response.id
            echo "âœ… Gitee Release åˆ›å»ºæˆåŠŸï¼ŒID: $releaseId"
            
            # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Gitee Release
            $files = Get-ChildItem -Path . -Include *.exe,*.msi,*.zip -File
            foreach ($file in $files) {
              echo "ğŸ“¦ æ­£åœ¨ä¸Šä¼  $($file.Name) åˆ° Gitee Release..."
              $uploadUrl = "https://gitee.com/api/v5/repos/ghost-him/ZeroLaunch-rs/releases/$releaseId/attach_files?access_token=$env:GITEE_TOKEN"
              
              # ä½¿ç”¨ curl ä¸Šä¼ æ–‡ä»¶ï¼ˆæ›´å¯é ï¼‰
              curl.exe -X POST $uploadUrl -F "file=@$($file.FullName)" --silent --show-error
              
              if ($LASTEXITCODE -eq 0) {
                echo "âœ… å·²ä¸Šä¼ : $($file.Name)"
              } else {
                echo "âŒ ä¸Šä¼ å¤±è´¥: $($file.Name)"
                throw "Failed to upload $($file.Name) to Gitee"
              }
            }
            
            echo "âœ… Gitee Release æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
          } catch {
            echo "âŒ Gitee Release åˆ›å»ºæˆ–ä¸Šä¼ å¤±è´¥: $_"
            throw
          }

      - name: Upload to GitCode
        if: success()
        shell: pwsh
        run: |
          # é…ç½® GitCode
          git config --global user.name "ghost-him"
          git config --global user.email "$env:GITCODE_EMAIL"
          
          # æ·»åŠ  GitCode è¿œç¨‹ä»“åº“
          git remote add gitcode "https://oauth2:$($env:GITCODE_TOKEN)@gitcode.com/ghost-him/ZeroLaunch-rs.git" || true
          
          git checkout main

          # æ¨é€ä»£ç å’Œæ ‡ç­¾åˆ° GitCode
          git push gitcode main --tags -f || echo "Failed to push to GitCode"
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITCODE_EMAIL: ${{ secrets.GITCODE_EMAIL }}

      - name: Create and Upload to GitCode Release
        if: success()
        shell: pwsh
        env:
          VERSION: ${{ needs.build.outputs.version }}
          RELEASE_TITLE: ${{ needs.build.outputs.release_title }}
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
        run: |
          $version = $env:VERSION
          $releaseTitle = $env:RELEASE_TITLE
          $tag = "v$version"
          $owner = "ghost-him"
          $repo = "ZeroLaunch-rs"
          $token = $env:GITCODE_TOKEN

          # è¯»å–ç”Ÿæˆçš„ Release Notes
          $releaseNotes = Get-Content -Path "release_notes.txt" -Raw -Encoding UTF8

          # æ ¹æ® GitCode API è§„èŒƒï¼Œtoken éœ€è¦ç»Ÿä¸€æ”¾åœ¨ Header ä¸­
          $headers = @{
            "Content-Type" = "application/json"
            "Private-Token" = $token
          }

          try {
            # 1. å°è¯•åˆ é™¤æ—§çš„ Release (ç¡®ä¿å¹‚ç­‰æ€§)
            # éœ€è¦å…ˆé€šè¿‡ tag è·å– release idï¼Œå†è¿›è¡Œåˆ é™¤
            try {
              $getReleaseUri = "https://gitcode.com/api/v5/repos/$owner/$repo/releases/tags/$tag"
              $existingRelease = Invoke-RestMethod -Uri $getReleaseUri -Method Get -Headers $headers -ErrorAction SilentlyContinue
              if ($existingRelease) {
                $releaseIdToDelete = $existingRelease.id
                $deleteUri = "https://gitcode.com/api/v5/repos/$owner/$repo/releases/$releaseIdToDelete"
                Invoke-RestMethod -Uri $deleteUri -Method Delete -Headers $headers
                echo "å·²åˆ é™¤æ—§çš„ GitCode Release"
              }
            } catch {
              echo "æ²¡æœ‰æ—§çš„ GitCode Release éœ€è¦åˆ é™¤"
            }

            # 2. åˆ›å»ºæ–°çš„ Release
            $createReleaseUri = "https://gitcode.com/api/v5/repos/$owner/$repo/releases"
            $releaseBody = @{
              tag_name = $tag
              name = $releaseTitle
              body = $releaseNotes
              target_commitish = "main"
            } | ConvertTo-Json

            $response = Invoke-RestMethod -Uri $createReleaseUri -Method Post -Headers $headers -Body $releaseBody
            $releaseId = $response.id
            echo "âœ… GitCode Release åˆ›å»ºæˆåŠŸï¼ŒID: $releaseId"

            # 3. ä¸Šä¼ æ„å»ºäº§ç‰©ä½œä¸ºé™„ä»¶
            $files = Get-ChildItem -Path . -Include *.exe,*.msi,*.zip -File
            foreach ($file in $files) {
              echo "ğŸ“¦ æ­£åœ¨ä¸Šä¼  $($file.Name) åˆ° GitCode Release..."
              $uploadUrl = "https://gitcode.com/api/v5/repos/$owner/$repo/releases/$releaseId/attach_files"

              # ä½¿ç”¨ curl ä¸Šä¼ æ–‡ä»¶ï¼Œå¯¹äº multipart/form-data æ›´å¯é ï¼Œå¹¶å°† token æ”¾å…¥ header
              curl.exe -X POST $uploadUrl -H "Private-Token: $token" -F "file=@$($file.FullName)" --silent --show-error

              if ($LASTEXITCODE -eq 0) {
                echo "âœ… å·²ä¸Šä¼ : $($file.Name)"
              } else {
                echo "âŒ ä¸Šä¼ å¤±è´¥: $($file.Name)"
                throw "Failed to upload $($file.Name) to GitCode"
              }
            }

            echo "âœ… GitCode Release æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
          } catch {
            echo "âŒ GitCode Release åˆ›å»ºæˆ–ä¸Šä¼ å¤±è´¥: $_"
            throw
          }
            
  notify:
    name: Notify on completion
    needs:
      - build
      - release
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify build status
        run: |
          if [[ "${{ needs.build.result }}" == "success" && "${{ needs.release.result }}" == "success" ]]; then
            echo "âœ… Build and release completed successfully!"
          else
            echo "âŒ Workflow failed. Status:"
            echo "  - Build Job: ${{ needs.build.result }}"
            echo "  - Release Job: ${{ needs.release.result }}"
            exit 1
          fi