set -e

echo "Running pre-commit checks..."

# 0. æ£€æŸ¥æ˜¯å¦å­˜åœ¨æœªæš‚å­˜æˆ–æœªè·Ÿè¸ªçš„æ–‡ä»¶
# git diff --name-only: å·¥ä½œåŒºä¸æš‚å­˜åŒºçš„å·®å¼‚ï¼ˆå·²ä¿®æ”¹ä½†æœªæš‚å­˜ï¼‰
UNSTAGED_FILES=$(git diff --name-only)
# git ls-files: æœªè¢« git è·Ÿè¸ªçš„æ–‡ä»¶
UNTRACKED_FILES=$(git ls-files --others --exclude-standard)

if [ -n "$UNSTAGED_FILES" ] || [ -n "$UNTRACKED_FILES" ]; then
  echo "âš ï¸  æ£€æµ‹åˆ°ä»¥ä¸‹æ–‡ä»¶å°šæœªè¢«æš‚å­˜ï¼š"

  if [ -n "$UNSTAGED_FILES" ]; then
    echo "$UNSTAGED_FILES" | sed 's/^/  â€¢ ä¿®æ”¹æœªæš‚å­˜: /'
  fi

  if [ -n "$UNTRACKED_FILES" ]; then
    echo "$UNTRACKED_FILES" | sed 's/^/  â€¢ æ–°æ–‡ä»¶æœªæš‚å­˜: /'
  fi

  while true; do
    printf "æ˜¯å¦ç»§ç»­æ‰§è¡Œæäº¤æµç¨‹ï¼Ÿ[y/N]: "
    read -r answer < /dev/tty

    case "$answer" in
      [Yy]|[Yy][Ee][Ss])
        echo "ç»§ç»­æ‰§è¡Œæäº¤æµç¨‹..."
        break
        ;;
      ""|[Nn]|[Nn][Oo])
        echo "å·²ç»ˆæ­¢æäº¤ã€‚è¯·å…ˆå¤„ç†ä¸Šè¿°æ–‡ä»¶åå†æäº¤ã€‚"
        exit 1
        ;;
      *)
        echo "è¯·è¾“å…¥ y æˆ– nã€‚"
        ;;
    esac
  done
fi

# 1. æ„å»ºå‰ç«¯ï¼ˆç¡®ä¿ dist æ–‡ä»¶å¤¹å­˜åœ¨ï¼‰
echo "ğŸ—ï¸  Building frontend..."
bun run build

# 2. å¤åˆ¶ i18n locales æ–‡ä»¶åˆ° src-tauri
echo "ğŸ“¦ Copying i18n locales to src-tauri..."
SRC_LOCALES_DIR="src-ui/i18n/locales"
DEST_DIR="src-tauri/locales"

if [ ! -d "$DEST_DIR" ]; then
  mkdir -p "$DEST_DIR"
fi

cp -r "$SRC_LOCALES_DIR"/* "$DEST_DIR"/
echo "âœ“ i18n locales files copied to src-tauri/locales/"

# 3. å‰ç«¯é™æ€æ£€æŸ¥
echo "ğŸ“‹ Running frontend vue-tsc..."
bun run vue-tsc --noEmit

cd src-tauri
# 4. Rust æ ¼å¼æ£€æŸ¥
echo "ğŸ¨ Running Rust formatting check..."
cargo fmt --all -- --check
# 5. Rust é™æ€æ£€æŸ¥
echo "ğŸ“‹ Running Rust clippy..."
cargo clippy --all-targets --all-features -- -D warnings
# 6. Rust å•å…ƒæµ‹è¯•
echo "ğŸ§ª Running Rust tests..."
cargo test --all-features

echo "âœ… All pre-commit checks passed!"
